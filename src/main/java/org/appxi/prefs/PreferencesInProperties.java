package org.appxi.prefs;

import org.appxi.util.FileHelper;
import org.appxi.util.ext.OrderedProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Objects;
import java.util.Set;

public class PreferencesInProperties implements Preferences {
    public static final String COMMENT = "PLEASE DO NOT EDIT THIS FILE";

    private final Logger logger = LoggerFactory.getLogger(getClass());

    private final OrderedProperties prefs;
    private final Path file;
    private final boolean xmlMode;

    public PreferencesInProperties(Path file) {
        this(file, true, null);
    }

    public PreferencesInProperties(Path file, boolean load) {
        this(file, load, null);
    }

    public PreferencesInProperties(Path file, Charset charset) {
        this(file, true, charset);
    }

    public PreferencesInProperties(Path file, boolean load, Charset charset) {
        this.file = Objects.requireNonNull(file);
        this.prefs = new OrderedProperties();
        this.xmlMode = file.getFileName().toString().toLowerCase().endsWith(".xml");
        //
        if (load && Files.exists(file)) {
            try (InputStream inStream = new BufferedInputStream(Files.newInputStream(file))) {
                if (xmlMode) prefs.loadFromXML(inStream);
                else if (null != charset) prefs.load(new InputStreamReader(inStream, charset));
                else prefs.load(inStream);
            } catch (IOException e) {
                logger.warn("load PreferencesInProperties failed", e);
            }
        }
    }

    @Override
    @SuppressWarnings("unchecked")
    public OrderedProperties getPrefs() {
        return prefs;
    }

    @Override
    public Preferences setProperty(String key, Object val) {
        prefs.setProperty(key, String.valueOf(val));
        return this;
    }

    @Override
    public Object getProperty(String key) {
        return prefs.getProperty(key);
    }

    @Override
    public Object removeProperty(String key) {
        return prefs.removeProperty(key);
    }

    @Override
    public Set<String> getPropertyKeys() {
        return prefs.stringPropertyNames();
    }

    @Override
    public boolean containsProperty(String key) {
        return prefs.containsProperty(key);
    }

    @Override
    public void save() {
        FileHelper.makeParents(file);
        try (OutputStream outStream = Files.newOutputStream(file)) {
            if (xmlMode) this.prefs.storeToXML(outStream, COMMENT);
            else this.prefs.store(outStream, COMMENT);
        } catch (IOException e) {
            logger.warn("save PreferencesInProperties failed", e);
        }
    }

    @Override
    public void clear() {
        prefs.clear();
    }
}
